name: VALIDATE

on:
  push:

jobs:

  documentation:
    runs-on: ubuntu-latest
    environment: CI
    steps:
      - name: install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -yq \
          doxygen \
          ghostscript \
          graphviz \
          latexmk \
          libboost-all-dev \
          libfftw3-dev \
          python3-dev \
          python3-h5py \
          openmpi-bin \
          sphinx-common \
          texlive-latex-base \
          texlive-latex-extra \
          texlive-latex-recommended

      - uses: actions/checkout@v2
        with:
          path: 'espressopp'

      - name: build documentation
        run: |
          cmake -S espressopp -B espressopp-build
          cmake --build espressopp-build --target doxygen sphinx sphinx-pdf -j 2

      - uses: actions/checkout@v2
        with:
          repository: 'espressopp/espressopp.github.io.git'
          ref: 'master'
          path: 'html'

      - name: update docu repo
        working-directory: ${{github.workspace}}/html
        run: |
          rm -rf *
          mv ../espressopp-build/doc/sphinx/html/* .
          mv ../espressopp-build/doc/sphinx/pdf/ESPResSo++.pdf .

      - name: commit
        working-directory: ${{github.workspace}}/html
        run: |
          git config --global user.name "Automatic Deployment (Travis CI)";
          git config --global user.email "espp-devel@listserv.mpip-mainz.mpg.de";
          git add --all && git commit -m "Documentation Update";

      - name: register deploy key
        env:
          SSH_AUTH_SOCK: /tmp/ssh_agent.sock
        run: |
          ssh-agent -a $SSH_AUTH_SOCK > /dev/null
          ssh-add - <<< "${{ secrets.PAGES_KEY }}"

      - name: deploy documentation
        env:
          SSH_AUTH_SOCK: /tmp/ssh_agent.sock
        working-directory: ${{github.workspace}}/html
        run: git push git@github.com:espressopp/espressopp.github.io.git master;

