message(STATUS "EXTERNAL_BOOST=${EXTERNAL_BOOST}")
if (EXTERNAL_BOOST)
    set(Boost_LIBS ${Boost_LIBRARIES})
    find_package (Boost COMPONENTS unit_test_framework REQUIRED)

    list(APPEND Boost_LIBS ${Boost_LIBRARIES})
    set(Boost_LIBRARIES ${Boost_LIBS})

    include_directories(${Boost_INCLUDE_DIRS})
else(EXTERNAL_BOOST)
    set(Boost_LIBRARIES espressopp_boost_test)
    include_directories(${CMAKE_CURRENT_SOURCE_DIR}/../contrib/boost)
endif()

include_directories(${CMAKE_CURRENT_SOURCE_DIR}/../src/include)

file(GLOB ALL_DIRS ${CMAKE_CURRENT_SOURCE_DIR}/*)
foreach(DIR ${ALL_DIRS})
    if(IS_DIRECTORY ${DIR})
        if (EXISTS "${DIR}/IGNORE")
            continue()
        endif()
        if (EXISTS "${DIR}/CMakeLists.txt")
            add_subdirectory(${DIR})
        else()
            file(GLOB TESTS "${DIR}/*Test*.cpp")
            foreach(TEST_FILE ${TESTS})
                get_filename_component(TEST_NAME ${TEST_FILE} NAME_WE)
                get_filename_component(TEST_FILENAME ${TEST_FILE} NAME)
                add_executable(${TEST_NAME} ${DIR}/${TEST_FILENAME})
                if (EXTERNAL_BOOST)
                    add_definitions (-DBOOST_TEST_DYN_LINK)
                endif()
                add_test(${TEST_NAME} ${CMAKE_CURRENT_BINARY_DIR}/${TEST_NAME})
                set_tests_properties(${TEST_NAME} PROPERTIES ENVIRONMENT "${TEST_ENV}")
                target_link_libraries(${TEST_NAME} ${PYTHON_LIBRARIES} ${MPI_LIBRARIES} ${FFTW3_LIBRARIES} _espressopp ${Boost_LIBRARIES})
            endforeach()

            file(GLOB TESTS_PY "${DIR}/test*.py")
            foreach(TEST_FILE ${TESTS_PY})
                get_filename_component(TEST_NAME ${TEST_FILE} NAME_WE)
                add_test(${TEST_NAME} ${Python3_EXECUTABLE} ${CMAKE_CURRENT_SOURCE_DIR}/${TEST_NAME})
                set_tests_properties(${TEST_NAME} PROPERTIES ENVIRONMENT "${TEST_ENV}")
            endforeach()
        endif()
    endif()
endforeach()
