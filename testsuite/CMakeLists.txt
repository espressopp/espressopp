find_package (Boost COMPONENTS system filesystem unit_test_framework REQUIRED)
include_directories(${Boost_INCLUDE_DIRS})
add_definitions (-DBOOST_TEST_DYN_LINK)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/../src/include)

file(GLOB ALL_DIRS *)
foreach(DIR ${ALL_DIRS})
    if(IS_DIRECTORY ${DIR})
        if (EXISTS "${DIR}/CMakeLists.txt")
            add_subdirectory(${DIR})
        else()
            file(GLOB TESTS "${DIR}/*Test*.cpp")
            foreach(TEST_FILE ${TESTS})
                get_filename_component(TEST_NAME ${TEST_FILE} NAME_WE)
                add_executable(${TEST_NAME} ${TEST_FILE})
                add_test(${TEST_NAME} ${CMAKE_CURRENT_BINARY_DIR}/${DIR}/${TEST_NAME}.cpp)
                set_tests_properties(${TEST_NAME} PROPERTIES ENVIRONMENT "${TEST_ENV}")
                target_link_libraries(${TEST_NAME} ${Boost_LIBRARIES} ${PYTHON_LIBRARIES} ${MPI_LIBRARIES} ${FFTW3_LIBRARIES} _espressopp)
            endforeach()

            file(GLOB TESTS_PY "${DIR}/*.py")
            foreach(TEST_FILE ${TESTS_PY})
                get_filename_component(TEST_NAME ${TEST_FILE} NAME_WE)
                add_test(${TEST_NAME} ${PYTHON_EXECUTABLE} ${CMAKE_CURRENT_SOURCE_DIR}/${DIR}/${TEST_NAME}.py)
                set_tests_properties(${TEST_NAME} PROPERTIES ENVIRONMENT "${TEST_ENV}")
            endforeach()
        endif()
    endif()
endforeach()
